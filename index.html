<html>
<head>
    <title>ウェブカメラから顔を認識する</title>
    <style>
        #app {
            position:relative;
        }
        #app * {
            position: absolute;
        }
    </style>
</head>
<body>
<div id="app">
    <video ref="video" width="720" height="560" @play="onPlay"></video>
    <canvas ref="canvas" width="720" height="560"></canvas>
</div>
<script src="https://cdn.jsdelivr.net/npm/vue@2.6.10/dist/vue.min.js"></script>
<script src="/js/face-api.js/dist/face-api.min.js"></script>
<script>

    new Vue({
        el: '#app',
        data: {
            MODEL_URI: '/js/face-api.js/weights',   // 顔認識モデルの場所
        },
        computed: {
            video() {

                return this.$refs['video'];

            },
            canvas() {

                return this.$refs['canvas'];

            }
        },
        methods: {
            onPlay() {

                const video = this.video;
                const canvas = this.canvas;

                setInterval(async () => {

                    // ウェブカメラの映像から顔データを取得
                    const detections = await faceapi.detectAllFaces(
                        this.video,
                        new faceapi.TinyFaceDetectorOptions()
                    )
                    .withFaceLandmarks()
                    .withFaceExpressions();

                    // 顔データをリサイズ
                    const resizedDetections = faceapi.resizeResults(detections, {
                        width: video.width,
                        height: video.height
                    });

                    // キャンバスに描画
                    canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
                    faceapi.draw.drawDetections(canvas, resizedDetections);
                    faceapi.draw.drawFaceLandmarks(canvas, resizedDetections);
                    faceapi.draw.drawFaceExpressions(canvas, resizedDetections)

                }, 500);

            }
        },
        mounted() {

            // 顔モデルをロード
            Promise.all([
                faceapi.nets.tinyFaceDetector.loadFromUri(this.MODEL_URI),
                faceapi.nets.faceLandmark68Net.loadFromUri(this.MODEL_URI),
                faceapi.nets.faceExpressionNet.loadFromUri(this.MODEL_URI)
            ])
            .then(() => {

                // ウェブカメラへアクセス
                navigator.mediaDevices.getUserMedia({ video: true })
                    .then((stream) => {

                        this.video.srcObject = stream;
                        this.video.play();

                    });

            });

        }
    });

</script>
</body>
</html>
